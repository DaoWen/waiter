dist: trusty
group: deprecated-2017Q4
language: java
jdk: oraclejdk8

addons:
  artifacts: true

branches:
  only: master

cache:
  directories:
    - $HOME/.lein
    - $HOME/.local/bin
    - $HOME/.m2
    - $HOME/.voom-repos

before_install:
  - unset _JAVA_OPTIONS  # Avoid unwanted _JAVA_OPTIONS set by Travis CI
  - echo "Sudo-enabled build? ${TRAVIS_SUDO}"
  - voom-build() { lein with-profiles +test voom build-deps; }

install:
  - ./waiter/bin/ci/install-lein

matrix:
  include:
    - env: NAME='Kitchen tests'
      before_script: cd kitchen && voom-build
      script: lein test

    - env: NAME='Token syncer tests'
      before_script: cd token-syncer && voom-build
      script: ./bin/ci/run-all-tests.sh

    - env: NAME='Waiter unit tests'
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-unit-tests.sh

    - env: "NAME='Waiter integration tests: kubernetes-fast'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests-k8s-scheduler.sh parallel-test integration-fast

    - env: "NAME='Waiter integration tests: kubernetes-slow-heavy'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests-k8s-scheduler.sh test integration-slow-heavy

    - env: "NAME='Waiter integration tests: kubernetes-slow-lite'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests-k8s-scheduler.sh parallel-test integration-slow-lite

    - env: "NAME='Waiter integration tests: marathon-fast'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests.sh parallel-test integration-fast

    - env: "NAME='Waiter integration tests: marathon-slow'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests.sh parallel-test integration-slow

    - env: "NAME='Waiter integration tests: shell-fast'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests-shell-scheduler.sh parallel-test integration-fast

    - env: "NAME='Waiter integration tests: shell-slow'"
      services: docker
      before_script: cd waiter && voom-build
      script: ./bin/ci/run-integration-tests-shell-scheduler.sh parallel-test integration-slow
